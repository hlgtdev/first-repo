<link rel="stylesheet" href="css/piano.css" />
<script src="./lib/Tone.js"></script>
<script>
isPlaying = false
playMusic = true
tempo = 60
rate = 60 / tempo
kTimeout = 850

synth = new Tone.PolySynth(Tone.Synth).toDestination();

function play() {

  isPlaying = true

  portee(synth, -1, [
      ], [
          "C3,G3:0.5",
          "C3,G3:0.5",
          "D3,A3:3",

          "C3,G3:0.5",
          "C3,G3:0.5",
          "D3,A3:3",

          "A#2,F3:0.5",
          "A#2,F3:0.5",
          "C3,G3:3",

          "C3,G3:0.5",
          "C3,G3:0.5",
          "D3,A3:3",
      ])

  portee(synth, 0, [
          "r:1.75",
      ], [
          "F4:0.5",
          "E4:0.25",
          "D4:0.25",
          "C4:0.25",
          "A#3:0.5",
          "A3:1.25",
          "r:1",

          "D4:0.5",
          "E4:0.25",
          "F4:0.25",
          "G4:0.25",
          "A4:0.25",
          "A#4:0.25",
          "A4:1",
          "r:1.25",

          "A4:0.5",
          "G4:0.25",
          "F4:0.25",
          "A4:0.25",
          "G4:0.25",
          "F4:0.25",
          "E4:1",
          "r:1.25",

          "F4:0.5",
          "E4:0.25",
          "D4:0.25",
          "C4:0.25",
          "C4:0.25",
          "D4:0.25",
          "D4:1",
          "r:1.25",
      ])

      Tone.Transport.start()
}

function portee(synth, octaveOffsetShown, accordsBefore, accords) {

        at = 0

        if (accordsBefore.length > 0) {
            accordsBefore = gererListeAccords(octaveOffsetShown, accordsBefore)

            nb = accordsBefore.length
            lastTime = accordsBefore[nb - 1][0]
            lastDuree = accordsBefore[nb - 1][1][0]
            at = lastTime + lastDuree

		    prePart = new Tone.Part(((time, chord) => {
		        duree = chord[0]
            octaveOffsetShown = chord[2]
		        chord = chord[1]
		        console.log(time, duree, chord)

            markNotes(chord, octaveOffsetShown)

			    synth.triggerAttackRelease(chord, duree, time);

          setTimeout(unmarkNotes, duree * kTimeout, chord, octaveOffsetShown)
		    }), accordsBefore).start(0);
        }

        accords = gererListeAccords(octaveOffsetShown, accords)

        nb = accords.length
        lastTime = accords[nb - 1][0]
        lastDuree = accords[nb - 1][1][0]

		pianoPart = new Tone.Part(((time, chord) => {
		    duree = chord[0]
        octaveOffsetShown = chord[2]
		    chord = chord[1]
		    console.log(time, duree, chord)

		    markNotes(chord, octaveOffsetShown)

			synth.triggerAttackRelease(chord, duree, time)

      setTimeout(unmarkNotes, duree * kTimeout, chord, octaveOffsetShown)
		}), accords).start(at);

    pianoPart.loop = true;
		pianoPart.loopEnd = lastTime + lastDuree;
		pianoPart.humanize = true;
}

function gererListeAccords(octaveOffsetShown, accords) {

    t = 0
    liste = []

    for(var i in accords) {
        accord = accords[i]

        T = accord.split(":")
        sNotes = T[0]
        duree = parseFloat(T[1])
        notes = null

        if (sNotes != "r") {
            notes = sNotes.split(",")
        }
        liste.push([t, [ duree * rate, notes, octaveOffsetShown ]])
        t += duree * rate

        console.log(t, notes)
    }
    return liste
}

function loadKeyboard() {

    gamme = [ 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B' ]

    doc = ''
    doc += '<link rel="stylesheet" href="css/piano.css" />'
    doc += '<h1>Child in time (Deep Purple)</h1>'
    doc += '<h2>Intro</h2>'
    doc += '<p>Appuyer sur une touche du piano pour d√©marrer</p>'
    doc += '<div class="keys">'

    for (var i = 0; i < 53; i++) {
        rang = i % 12
        octave = 1 + Math.floor(i / 12)
        sharp = gamme[rang].indexOf('#') > -1 ? ' sharp' : ''
        offset = +127.3 - i * 4.9
        sharpStyle = gamme[rang].indexOf('#') > -1 ? ' style="margin-right: ' + offset + 'rem;"' : ''

        doc += '<div id="' + gamme[rang] + octave + '" class="key' + sharp + '"' + sharpStyle + '></div>'
    }
    doc += '</div>'

    document.write(doc)

    //attach a click listener to a play button
    document.querySelector('div')?.addEventListener('click', async () => {

      if (isPlaying == true) {
        return
      }

    	await Tone.start()
    	console.log('audio is ready')

      play()
    })
}

function markNotes(notes, octaveOffsetShown) {

  console.log(">>> MARK:", notes)

  for (var i in notes) {
      note = notes[i]

      if (note == null) {
        continue
      }

      noteSansOctave = note.substring(0, note.length - 1)
      octave = parseInt(note.substring(note.length - 1, note.length))
      note = noteSansOctave + (octave + octaveOffsetShown)

      key = document.getElementById(note)
      key.style.borderStyle = 'solid'
      key.style.borderColor = 'red'
    }
}

function unmarkNotes(notes, octaveOffsetShown) {

    console.log(">>> UNMARK:", notes)

    for (var i in notes) {
        note = notes[i]

        if (note == null) {
          continue
        }

        noteSansOctave = note.substring(0, note.length - 1)
        octave = parseInt(note.substring(note.length - 1, note.length))
        note = noteSansOctave + (octave + octaveOffsetShown)

        key = document.getElementById(note)

        if (note.indexOf('#') > -1) {
          key.style.borderStyle = 'solid'
          key.style.borderTopColor = '#666666'
          key.style.borderRightColor = '#222222'
          key.style.borderBottomColor = '#111111'
          key.style.borderLeftColor = '#555555'
        }
        else {
          key.style.borderStyle = 'none'
        }
    }
}
</script>
<body onload="loadKeyboard()">
